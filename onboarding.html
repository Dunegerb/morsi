<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#141414">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <title>MORSI - Welcome</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <!-- NEW: Add Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Styles are identical to your previous version, so they are omitted here for brevity -->
    <style>
        /* style.css (Base styles from original file + new onboarding styles) */

        /*------------------------------------*\
          #ROOT & GLOBAL ARCHITECTURE
        \*------------------------------------*/
        :root {
            --bg-main: #141414;
            --bg-card: #1F1F1F;
            --text-primary: #F1EBEB;
            --text-secondary: rgba(241, 235, 235, 0.7);
            --text-tertiary: rgba(241, 235, 235, 0.5);
            --accent-blue: #2A52AA;
            --accent-red: #AD1E20;
            --font-main: 'Instrument Sans', sans-serif;
            --card-radius: 24px;
            --h-safe-area: env(safe-area-inset-left);
            --v-safe-area-top: env(safe-area-inset-top);
            --v-safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            width: 100%;
            min-height: 100dvh;
            margin: 0 auto;
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: var(--font-main);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /*------------------------------------*\
          #APP LAYOUT FLOW (Shared)
        \*------------------------------------*/
        .app-header {
            flex-shrink: 0;
            padding-top: calc(3rem + var(--v-safe-area-top));
            padding-bottom: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo svg {
            width: auto;
            height: 1.6rem;
        }
        
        /*------------------------------------*\
          #ONBOARDING-SPECIFIC STYLES
        \*------------------------------------*/
        .app-main {
            flex-grow: 1;
            display: flex; /* Changed for onboarding layout */
            overflow: hidden; /* Hide overflow of the sliding steps */
        }
        
        .onboarding-container {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .onboarding-step {
            flex-shrink: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Aligned to top for content flow */
            align-items: center;
            text-align: center;
            padding: 0 5.2%;
        }

        .step-content {
            width: 100%;
            max-width: 400px; /* Constrain content width */
        }

        .step-content h1 {
            font-size: 2rem;
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 0.75rem;
        }

        .step-content .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Input Fields */
        .onboarding-input,
        .onboarding-textarea {
            width: 100%;
            background-color: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1rem;
            font-family: var(--font-main);
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .onboarding-input::placeholder,
        .onboarding-textarea::placeholder {
            color: var(--text-tertiary);
        }
        .onboarding-input:focus,
        .onboarding-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(42, 82, 170, 0.5);
        }
        .onboarding-textarea {
            min-height: 120px;
            resize: none;
        }

        /* Video Oath Step */
        .video-oath-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 200px;
            background-color: var(--bg-card);
            border: 2px dashed var(--text-tertiary);
            border-radius: var(--card-radius);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .video-oath-container.recorded {
            border-style: solid;
            border-color: var(--accent-green);
        }
        #record-button-icon {
            width: 64px;
            height: 64px;
            color: var(--text-secondary);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #record-button-text {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .video-oath-container:hover {
            border-color: var(--text-secondary);
        }
        .video-oath-container.recorded #record-button-icon {
            transform: scale(0.8);
            color: var(--accent-green);
        }

        /* Onboarding Navigation */
        .onboarding-nav {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem var(--h-safe-area) calc(1.5rem + var(--v-safe-area-bottom)) var(--h-safe-area);
            background: var(--bg-main);
        }
        .nav-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: var(--font-main);
            font-size: 1.1rem;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: color 0.3s ease, opacity 0.3s ease;
            visibility: visible;
            opacity: 1;
        }
        .nav-button.hidden {
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        .nav-button.primary {
            background-color: var(--accent-blue);
            color: var(--text-primary);
            border-radius: 100px;
        }
        .nav-button.primary:disabled {
            background-color: #505050;
            cursor: not-allowed;
        }

        .progress-dots {
            display: flex;
            gap: 8px;
        }
        .dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-tertiary);
            border-radius: 50%;
            transition: all 0.4s ease;
        }
        .dot.active {
            background-color: var(--text-primary);
            transform: scale(1.2);
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo">
            <!-- SVG Logo -->
            <svg xmlns="http://www.w3.org/2000/svg" width="93" height="26" viewBox="0 0 93 26" fill="none"><path d="M26.806 21V5.88H29.452L34.912 20.454H34.114L39.532 5.88H42.22V21H40.519V6.783H40.75L35.479 21H33.421L28.15 6.909H28.381V21H26.806ZM52.2843 21.21C51.2343 21.21 50.2683 21.021 49.3863 20.643C48.5183 20.251 47.7623 19.705 47.1182 19.005C46.4743 18.291 45.9703 17.458 45.6063 16.506C45.2563 15.554 45.0813 14.511 45.0813 13.377C45.0813 11.879 45.3893 10.549 46.0053 9.387C46.6213 8.225 47.4683 7.315 48.5463 6.657C49.6383 5.999 50.8773 5.67 52.2633 5.67C53.6773 5.67 54.9233 5.999 56.0013 6.657C57.0933 7.315 57.9473 8.225 58.5633 9.387C59.1793 10.549 59.4873 11.886 59.4873 13.398C59.4873 14.532 59.3053 15.575 58.9413 16.527C58.5913 17.479 58.0943 18.305 57.4503 19.005C56.8063 19.705 56.0433 20.251 55.1613 20.643C54.2793 21.021 53.3203 21.21 52.2843 21.21ZM52.2633 19.656C53.3413 19.656 54.2863 19.39 55.0983 18.858C55.9243 18.312 56.5683 17.563 57.0303 16.611C57.4923 15.659 57.7233 14.574 57.7233 13.356C57.7233 12.152 57.4923 11.088 57.0303 10.164C56.5823 9.24 55.9453 8.519 55.1192 8.001C54.3073 7.483 53.3553 7.224 52.2633 7.224C51.1713 7.224 50.2193 7.483 49.4073 8.001C48.5953 8.519 47.9653 9.24 47.5173 10.164C47.0693 11.074 46.8453 12.138 46.8453 13.356C46.8453 14.588 47.0693 15.68 47.5173 16.632C47.9793 17.57 48.6163 18.312 49.4282 18.858C50.2403 19.39 51.1853 19.656 52.2633 19.656ZM62.346 21V5.88H67.932C69.01 5.88 69.927 6.055 70.683 6.405C71.439 6.755 72.013 7.245 72.405 7.875C72.811 8.491 73.014 9.226 73.014 10.08C73.014 10.934 72.811 11.683 72.405 12.327C72.013 12.957 71.439 13.454 70.683 13.818C69.927 14.168 69.01 14.343 67.932 14.343H63.606V12.831H67.869C68.989 12.831 69.836 12.586 70.41 12.096C70.998 11.606 71.292 10.934 71.292 10.08C71.292 9.24 71.005 8.582 70.431 8.106C69.857 7.63 69.003 7.392 67.869 7.392H64.068V21H62.346ZM71.208 21L63.165 13.503H65.517L73.812 21H71.208ZM81.0257 21.189C79.2617 21.189 77.8547 20.755 76.8047 19.887C75.7687 19.019 75.1597 17.78 74.9777 16.17H76.6577C76.8117 17.332 77.2527 18.207 77.9807 18.795C78.7087 19.383 79.7167 19.677 81.0047 19.677C82.0967 19.677 82.9157 19.474 83.4617 19.068C84.0217 18.648 84.3017 18.039 84.3017 17.241C84.3017 16.555 84.1127 16.009 83.7347 15.603C83.3567 15.197 82.7687 14.861 81.9707 14.595L79.4297 13.713C78.1417 13.265 77.1897 12.726 76.5737 12.096C75.9577 11.452 75.6497 10.64 75.6497 9.66C75.6497 8.848 75.8527 8.148 76.2587 7.56C76.6647 6.958 77.2387 6.489 77.9807 6.153C78.7227 5.817 79.5837 5.649 80.5637 5.649C82.0757 5.649 83.2867 6.048 84.1967 6.846C85.1067 7.63 85.6317 8.75 85.7717 10.206H84.0917C83.9097 9.156 83.5317 8.386 82.9577 7.896C82.3977 7.406 81.5857 7.161 80.5217 7.161C79.5137 7.161 78.7297 7.364 78.1697 7.77C77.6097 8.176 77.3297 8.75 77.3297 9.492C77.3297 10.122 77.5257 10.626 77.9177 11.004C78.3097 11.382 78.9187 11.711 79.7447 11.991L82.4537 12.936C83.6297 13.342 84.5117 13.895 85.0997 14.595C85.6877 15.281 85.9817 16.156 85.9817 17.22C85.9817 18.48 85.5477 19.46 84.6797 20.16C83.8257 20.846 82.6077 21.189 81.0257 21.189ZM88.6781 21V5.88H90.4001V21H88.6781Z" fill="#E0D7D7"></path><path d="M6.38891 18.381C6.38892 20.8707 8.51542 23 8.51542 23C8.51542 23 10.4262 21.1328 10.6419 18.7741C10.8775 16.1985 10.6419 14.9414 12.1829 12.3534C13.3617 10.3736 16.2201 8.16034 16.2201 8.16034V4.03276C16.2201 4.03276 11.4311 6.78911 9.43998 9.66724C7.41627 12.5925 6.38891 14.75 6.38891 18.381Z" fill="#E0D7D7"></path><path d="M5.49515 19.9534C5.70512 20.7346 6.35808 21.8207 6.35808 21.8207C6.35808 21.8207 2.79178 20.1172 1.1805 17.1034C-0.693476 13.5983 0.225117 8.97931 0.225117 8.97931C0.225117 8.97931 2.93719 10.9776 3.98502 13.4017C5.0197 15.7954 5.0637 18.3483 5.49515 19.9534Z" fill="#E0D7D7"></path><path d="M11.5048 19.9534C11.2949 20.7346 10.6419 21.8207 10.6419 21.8207C10.6419 21.8207 14.2082 20.1172 15.8195 17.1034C17.6935 13.5983 16.7749 8.97931 16.7749 8.97931C16.7749 8.97931 14.0628 10.9776 13.015 13.4017C11.9803 15.7954 11.9363 18.3483 11.5048 19.9534Z" fill="#E0D7D7"></path><path d="M3.4303 10.4534C4.68053 11.8638 5.92663 14.6466 5.92663 14.6466C5.92663 14.6466 6.36205 13.2352 6.75874 12.3862C7.16736 11.5117 7.9915 10.2569 7.9915 10.2569C7.9915 10.2569 6.16528 7.91231 4.75551 6.68621C3.33168 5.44788 0.77987 4 0.77987 4V8.1931C0.77987 8.1931 2.52026 9.42684 3.4303 10.4534Z" fill="#E0D7D7"></path></svg>
        </div>
    </header>

    <main class="app-main">
        <div class="onboarding-container">
            <!-- Step 1: Name -->
            <div class="onboarding-step">
                <div class="step-content">
                    <h1>Welcome to Morsi</h1>
                    <p class="subtitle">Your journey to a better self starts now. Let's begin with your name.</p>
                    <input type="text" id="userName" class="onboarding-input" placeholder="e.g., Alex">
                </div>
            </div>

            <!-- Step 2: Habit -->
            <div class="onboarding-step">
                <div class="step-content">
                    <h1>What are we leaving behind?</h1>
                    <p class="subtitle">Be specific. This is for you and you alone.</p>
                    <input type="text" id="userHabit" class="onboarding-input" placeholder="e.g., Vaping, Procrastination">
                </div>
            </div>

            <!-- Step 3: Motivation -->
            <div class="onboarding-step">
                <div class="step-content">
                    <h1>What is your "Why"?</h1>
                    <p class="subtitle">What will you gain by succeeding? This is your core motivation.</p>
                    <textarea id="userMotivation" class="onboarding-textarea" placeholder="e.g., More energy, better health, clarity of mind..."></textarea>
                </div>
            </div>

            <!-- Step 4: Video Oath -->
            <div class="onboarding-step">
                <div class="step-content">
                    <h1>A message to yourself</h1>
                    <p class="subtitle">Record a short, honest video. Speak to your future self when they feel weak. Remind them of your "Why". This is your oath.</p>
                    <div id="video-oath-trigger" class="video-oath-container">
                        <div id="record-button-icon">
                           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle></svg>
                        </div>
                        <span id="record-button-text">Tap to Record</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav class="onboarding-nav">
        <button id="back-button" class="nav-button">Back</button>
        <div class="progress-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <button id="next-button" class="nav-button primary">Next</button>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: SUPABASE INITIALIZATION ---
            const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // <-- Replace this
            const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // <-- Replace this
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const STATE = {
                currentStep: 0,
                totalSteps: 4,
                videoRecorded: false,
                data: {
                    name: '',
                    habit: '',
                    motivation: '',
                    videoOath: null
                }
            };

            const elements = {
                container: document.querySelector('.onboarding-container'),
                backButton: document.getElementById('back-button'),
                nextButton: document.getElementById('next-button'),
                dots: document.querySelectorAll('.progress-dots .dot'),
                inputs: {
                    name: document.getElementById('userName'),
                    habit: document.getElementById('userHabit'),
                    motivation: document.getElementById('userMotivation'),
                },
                videoTrigger: document.getElementById('video-oath-trigger'),
                recordIcon: document.getElementById('record-button-icon'),
                recordText: document.getElementById('record-button-text'),
            };

            const goToStep = (stepIndex) => {
                STATE.currentStep = stepIndex;
                gsap.to(elements.container, { x: `-${stepIndex * 100}%`, duration: 0.8, ease: "power3.inOut" });
                elements.dots.forEach((dot, index) => dot.classList.toggle('active', index === stepIndex));
                elements.backButton.classList.toggle('hidden', stepIndex === 0);
                elements.nextButton.textContent = (stepIndex === STATE.totalSteps - 1) ? 'Finish' : 'Next';
                validateCurrentStep();
            };

            const validateCurrentStep = () => {
                let isValid = false;
                switch (STATE.currentStep) {
                    case 0: isValid = elements.inputs.name.value.trim() !== ''; break;
                    case 1: isValid = elements.inputs.habit.value.trim() !== ''; break;
                    case 2: isValid = elements.inputs.motivation.value.trim() !== ''; break;
                    case 3: isValid = STATE.videoRecorded; break;
                    default: isValid = true;
                }
                elements.nextButton.disabled = !isValid;
            };

            const saveDataFromStep = (stepIndex) => {
                switch (stepIndex) {
                    case 0: STATE.data.name = elements.inputs.name.value.trim(); break;
                    case 1: STATE.data.habit = elements.inputs.habit.value.trim(); break;
                    case 2: STATE.data.motivation = elements.inputs.motivation.value.trim(); break;
                }
            };
            
            // --- MODIFIED: Finish Onboarding Logic ---
            const handleFinishOnboarding = async () => {
                elements.nextButton.disabled = true;
                elements.nextButton.textContent = 'Saving...';

                // 1. Get the current user session
                const { data: { session }, error: sessionError } = await _supabase.auth.getSession();
                
                if (sessionError || !session) {
                    console.error('Error getting session or no active session:', sessionError);
                    alert('Could not verify your session. Please log in again.');
                    window.location.href = 'login.html';
                    return;
                }
                
                const user = session.user;

                // 2. Prepare the data for Supabase
                const profileData = {
                    id: user.id, // This links the profile to the auth user
                    name: STATE.data.name,
                    habit: STATE.data.habit,
                    motivation: STATE.data.motivation
                };

                // 3. Upsert the data into the 'profiles' table
                // Upsert will insert a new row or update it if a profile with that ID already exists.
                const { error } = await _supabase.from('profiles').upsert(profileData);

                if (error) {
                    console.error('Error saving profile:', error);
                    alert('There was an error saving your profile. Please try again.');
                    elements.nextButton.disabled = false;
                    elements.nextButton.textContent = 'Finish';
                    return;
                }

                // 4. Mark onboarding as complete and redirect
                localStorage.setItem('morsiOnboardingComplete', 'true');
                
                gsap.to('body', {
                    opacity: 0,
                    duration: 0.5,
                    onComplete: () => { window.location.href = 'index.html'; }
                });
            };
            
            const handleNext = () => {
                saveDataFromStep(STATE.currentStep);
                if (STATE.currentStep < STATE.totalSteps - 1) {
                    goToStep(STATE.currentStep + 1);
                } else {
                    handleFinishOnboarding();
                }
            };
            
            const handleBack = () => {
                if (STATE.currentStep > 0) {
                    goToStep(STATE.currentStep - 1);
                }
            };
            
            const handleVideoRecord = () => {
                alert("This feature will open your camera to record a video message. For now, we'll mark it as complete.");
                STATE.videoRecorded = true;
                STATE.data.videoOath = 'simulated_video_path.mp4';
                elements.videoTrigger.classList.add('recorded');
                elements.recordText.textContent = "Oath Recorded";
                elements.recordIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                gsap.fromTo(elements.recordIcon, {scale: 0.5}, {scale: 1, duration: 0.6, ease: 'elastic.out(1, 0.5)'});
                validateCurrentStep();
            };

            const init = () => {
                // Check if user is logged in, if not, redirect to login
                _supabase.auth.getSession().then(({ data: { session } }) => {
                    if (!session) {
                        window.location.replace('login.html');
                    } else {
                        // User is logged in, show the page
                        goToStep(0);
                        gsap.from('.step-content, .onboarding-nav', {
                            opacity: 0, y: 20, duration: 0.8, stagger: 0.1, delay: 0.2, ease: "power3.out"
                        });
                    }
                });

                elements.nextButton.addEventListener('click', handleNext);
                elements.backButton.addEventListener('click', handleBack);
                elements.videoTrigger.addEventListener('click', handleVideoRecord);
                Object.values(elements.inputs).forEach(input => {
                    input.addEventListener('input', validateCurrentStep);
                });
            };

            init();
        });
    </script>
</body>
</html>
