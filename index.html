<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MORSI - Progress</title>

    <!-- PWA Meta Tags for Full-Screen Immersion -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1C1C1E">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-color: #1C1C1E;
            --card-color: #2C2C2C;
            --text-primary: #E0D7D7;
            --text-secondary: #959595;
            --text-tertiary: #5a5a5a;
            --accent-blue: #445DFF;
            --accent-red: #D7304A;
            --accent-green: #39CC59;
            --font-family: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: var(--font-family);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app-shell {
            width: 100%;
            height: 100%;
            max-width: 430px; /* Simulating iPhone 14 Pro Max width */
            max-height: 932px; /* Simulating iPhone 14 Pro Max height */
            background-color: var(--bg-color);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(255, 255, 255, 0.05);
            border-radius: 40px;
        }

        .main-content {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            padding-bottom: 120px; /* Space for nav bar */
        }
        .main-content::-webkit-scrollbar { display: none; } /* Hide scrollbar */

        header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            width: 100%;
        }

        .morsi-logo {
            width: 93px;
            height: auto;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 24px;
            padding: 20px;
        }

        /* Count Card */
        .count-card {
            position: relative;
        }

        .count-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .count-display {
            color: var(--text-secondary);
            font-size: 20px;
            font-weight: 500;
        }

        .count-number-wrapper {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-top: 4px;
        }

        .count-number {
            color: var(--text-primary);
            font-size: 64px;
            font-weight: 700;
            line-height: 1;
        }

        .count-unit {
            color: var(--text-secondary);
            font-size: 20px;
            font-weight: 500;
            transform: translateY(-4px);
        }

        .reset-btn {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            background: none;
            border: none;
            padding: 8px;
            transition: color 0.3s ease;
        }
        .reset-btn:hover {
            color: var(--text-primary);
        }

        .graph-container {
            margin-top: 24px;
            height: 200px;
            position: relative;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding: 0 20px 30px 20px;
            border-top: 1px solid rgba(149, 149, 149, 0.1);
            padding-top: 20px;
        }

        .graph-background {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            bottom: 30px;
            background-image: 
                repeating-linear-gradient(var(--bg-color) 0, var(--bg-color) 1px, transparent 1px, transparent 10px),
                repeating-linear-gradient(90deg, var(--bg-color) 0, var(--bg-color) 1px, transparent 1px, transparent 10px);
            background-size: 10px 10px;
            opacity: 0.1;
        }

        .graph-axis {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: calc(100% - 50px);
            pointer-events: none;
        }
        .graph-axis-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(149, 149, 149, 0.2) 10%, rgba(149, 149, 149, 0.2) 90%, transparent);
        }
        .graph-axis-line:nth-child(1) { top: 0; }
        .graph-axis-line:nth-child(2) { top: 50%; }
        .graph-axis-line:nth-child(3) { top: 100%; }


        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
            height: 100%;
            position: relative;
        }

        .graph-bar {
            width: 100%;
            border-radius: 16px 16px 0 0;
            position: absolute;
            bottom: 0;
            height: 0; /* Controlled by JS */
            display: flex;
            justify-content: center;
            transform-origin: bottom;
        }

        .bar-you { background-color: var(--accent-blue); }
        .bar-impulses { background-color: var(--accent-red); }

        .bar-icon {
            position: absolute;
            top: 16px;
            width: 24px;
            height: 24px;
            opacity: 0;
        }
        
        .bar-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .graph-label {
            position: absolute;
            bottom: -25px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Stage & Calendar Cards Layout */
        .secondary-cards-container {
            display: grid;
            grid-template-columns: 2fr 1.2fr;
            gap: 16px;
        }
        
        .stage-card, .calendar-card {
            padding: 20px;
        }
        
        .card-title {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Stage Card */
        .stage-card-content {
            display: flex;
            justify-content: space-between;
        }
        .stages-list {
            position: relative;
            overflow: hidden;
        }
        .stage-item {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            transition: color 0.5s ease;
        }
        .stage-item.active {
            color: var(--text-primary);
        }
        .stage-item.inactive {
            color: var(--text-tertiary);
        }

        .stage-indicator {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-around;
            padding-left: 10px;
        }
        .indicator-line {
            height: 2px;
            background-color: var(--text-tertiary);
            border-radius: 1px;
            transition: width 0.5s ease, background-color 0.5s ease;
            width: 10px;
        }
        .indicator-line.active {
            width: 20px;
            background-color: var(--text-primary);
        }
        .stage-footer {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Calendar Card */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        .calendar-day {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            background-color: #3F3F3F; /* Future day */
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        .calendar-day.complete { background-color: var(--text-secondary); }
        .calendar-day.current { background-color: var(--accent-green); }
        
        .calendar-labels {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 8px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Bottom Nav Bar */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: linear-gradient(180deg, rgba(28, 28, 30, 0) 0%, var(--bg-color) 30%);
            padding: 0 24px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease;
            opacity: 0.7;
        }
        .nav-item.active {
            color: var(--text-primary);
            opacity: 1;
        }
        .nav-item:hover {
            color: var(--text-primary);
            opacity: 1;
        }
        .nav-icon {
            width: 32px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .nav-icon svg {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .nav-item.active .nav-icon svg {
             transform: scale(1.1);
        }
        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

    </style>
</head>
<body>

    <div id="app-shell">
        <main class="main-content">
            <header>
                <!-- MORSI logo -->
                <svg class="morsi-logo" xmlns="http://www.w3.org/2000/svg" width="93" height="26" viewBox="0 0 93 26" fill="none">
                    <path d="M26.806 21V5.88H29.452L34.912 20.454H34.114L39.532 5.88H42.22V21H40.519V6.783H40.75L35.479 21H33.421L28.15 6.909H28.381V21H26.806ZM52.2843 21.21C51.2343 21.21 50.2683 21.021 49.3863 20.643C48.5183 20.251 47.7623 19.705 47.1182 19.005C46.4743 18.291 45.9703 17.458 45.6063 16.506C45.2563 15.554 45.0813 14.511 45.0813 13.377C45.0813 11.879 45.3893 10.549 46.0053 9.387C46.6213 8.225 47.4683 7.315 48.5463 6.657C49.6383 5.999 50.8773 5.67 52.2633 5.67C53.6773 5.67 54.9233 5.999 56.0013 6.657C57.0933 7.315 57.9473 8.225 58.5633 9.387C59.1793 10.549 59.4873 11.886 59.4873 13.398C59.4873 14.532 59.3053 15.575 58.9413 16.527C58.5913 17.479 58.0943 18.305 57.4503 19.005C56.8063 19.705 56.0433 20.251 55.1613 20.643C54.2793 21.021 53.3203 21.21 52.2843 21.21ZM52.2633 19.656C53.3413 19.656 54.2863 19.39 55.0983 18.858C55.9243 18.312 56.5683 17.563 57.0303 16.611C57.4923 15.659 57.7233 14.574 57.7233 13.356C57.7233 12.152 57.4923 11.088 57.0303 10.164C56.5823 9.24 55.9453 8.519 55.1192 8.001C54.3073 7.483 53.3553 7.224 52.2633 7.224C51.1713 7.224 50.2193 7.483 49.4073 8.001C48.5953 8.519 47.9653 9.24 47.5173 10.164C47.0693 11.074 46.8453 12.138 46.8453 13.356C46.8453 14.588 47.0693 15.68 47.5173 16.632C47.9793 17.57 48.6163 18.312 49.4282 18.858C50.2403 19.39 51.1853 19.656 52.2633 19.656ZM62.346 21V5.88H67.932C69.01 5.88 69.927 6.055 70.683 6.405C71.439 6.755 72.013 7.245 72.405 7.875C72.811 8.491 73.014 9.226 73.014 10.08C73.014 10.934 72.811 11.683 72.405 12.327C72.013 12.957 71.439 13.454 70.683 13.818C69.927 14.168 69.01 14.343 67.932 14.343H63.606V12.831H67.869C68.989 12.831 69.836 12.586 70.41 12.096C70.998 11.606 71.292 10.934 71.292 10.08C71.292 9.24 71.005 8.582 70.431 8.106C69.857 7.63 69.003 7.392 67.869 7.392H64.068V21H62.346ZM71.208 21L63.165 13.503H65.517L73.812 21H71.208ZM81.0257 21.189C79.2617 21.189 77.8547 20.755 76.8047 19.887C75.7687 19.019 75.1597 17.78 74.9777 16.17H76.6577C76.8117 17.332 77.2527 18.207 77.9807 18.795C78.7087 19.383 79.7167 19.677 81.0047 19.677C82.0967 19.677 82.9157 19.474 83.4617 19.068C84.0217 18.648 84.3017 18.039 84.3017 17.241C84.3017 16.555 84.1127 16.009 83.7347 15.603C83.3567 15.197 82.7687 14.861 81.9707 14.595L79.4297 13.713C78.1417 13.265 77.1897 12.726 76.5737 12.096C75.9577 11.452 75.6497 10.64 75.6497 9.66C75.6497 8.848 75.8527 8.148 76.2587 7.56C76.6647 6.958 77.2387 6.489 77.9807 6.153C78.7227 5.817 79.5837 5.649 80.5637 5.649C82.0757 5.649 83.2867 6.048 84.1967 6.846C85.1067 7.63 85.6317 8.75 85.7717 10.206H84.0917C83.9097 9.156 83.5317 8.386 82.9577 7.896C82.3977 7.406 81.5857 7.161 80.5217 7.161C79.5137 7.161 78.7297 7.364 78.1697 7.77C77.6097 8.176 77.3297 8.75 77.3297 9.492C77.3297 10.122 77.5257 10.626 77.9177 11.004C78.3097 11.382 78.9187 11.711 79.7447 11.991L82.4537 12.936C83.6297 13.342 84.5117 13.895 85.0997 14.595C85.6877 15.281 85.9817 16.156 85.9817 17.22C85.9817 18.48 85.5477 19.46 84.6797 20.16C83.8257 20.846 82.6077 21.189 81.0257 21.189ZM88.6781 21V5.88H90.4001V21H88.6781Z" fill="#E0D7D7"/>
                    <path d="M6.38891 18.381C6.38892 20.8707 8.51542 23 8.51542 23C8.51542 23 10.4262 21.1328 10.6419 18.7741C10.8775 16.1985 10.6419 14.9414 12.1829 12.3534C13.3617 10.3736 16.2201 8.16034 16.2201 8.16034V4.03276C16.2201 4.03276 11.4311 6.78911 9.43998 9.66724C7.41627 12.5925 6.38891 14.75 6.38891 18.381Z" fill="#E0D7D7"/>
                    <path d="M5.49515 19.9534C5.70512 20.7346 6.35808 21.8207 6.35808 21.8207C6.35808 21.8207 2.79178 20.1172 1.1805 17.1034C-0.693476 13.5983 0.225117 8.97931 0.225117 8.97931C0.225117 8.97931 2.93719 10.9776 3.98502 13.4017C5.0197 15.7954 5.0637 18.3483 5.49515 19.9534Z" fill="#E0D7D7"/>
                    <path d="M11.5048 19.9534C11.2949 20.7346 10.6419 21.8207 10.6419 21.8207C10.6419 21.8207 14.2082 20.1172 15.8195 17.1034C17.6935 13.5983 16.7749 8.97931 16.7749 8.97931C16.7749 8.97931 14.0628 10.9776 13.015 13.4017C11.9803 15.7954 11.9363 18.3483 11.5048 19.9534Z" fill="#E0D7D7"/>
                    <path d="M3.4303 10.4534C4.68053 11.8638 5.92663 14.6466 5.92663 14.6466C5.92663 14.6466 6.36205 13.2352 6.75874 12.3862C7.16736 11.5117 7.9915 10.2569 7.9915 10.2569C7.9915 10.2569 6.16528 7.91231 4.75551 6.68621C3.33168 5.44788 0.77987 4 0.77987 4V8.1931C0.77987 8.1931 2.52026 9.42684 3.4303 10.4534Z" fill="#E0D7D7"/>
                </svg>
            </header>

            <div class="cards-grid">
                <section class="card count-card">
                    <div class="count-header">
                        <div>
                            <div class="count-display">Count:</div>
                            <div class="count-number-wrapper">
                                <div id="count-number" class="count-number">0</div>
                                <div class="count-unit">days</div>
                            </div>
                        </div>
                        <button id="reset-btn" class="reset-btn">reset</button>
                    </div>

                    <div class="graph-container">
                        <div class="graph-background"></div>
                        <div class="graph-axis">
                            <div class="graph-axis-line"></div>
                            <div class="graph-axis-line"></div>
                            <div class="graph-axis-line"></div>
                        </div>

                        <div class="bar-wrapper">
                            <div id="bar-you" class="graph-bar bar-you">
                                <div class="bar-icon">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12.62 20.81C12.28 20.93 11.72 20.93 11.38 20.81C8.48 19.82 2 15.69 2 8.68998C2 5.59998 4.49 3.09998 7.56 3.09998C9.38 3.09998 10.99 3.97998 12 5.33998C13.01 3.97998 14.62 3.09998 16.44 3.09998C19.51 3.09998 22 5.59998 22 8.68998C22 15.69 15.52 19.82 12.62 20.81Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="graph-label">you</div>
                        </div>

                        <div class="bar-wrapper">
                            <div id="bar-impulses" class="graph-bar bar-impulses">
                                <div class="bar-icon">
                                     <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 9.5V10.5M16 9.5V10.5M10.11 16.03H13.89C14.39 16.03 14.74 15.57 14.59 15.11C14.2 13.89 13.2 13 12 13C10.8 13 9.8 13.89 9.41 15.11C9.26 15.57 9.61 16.03 10.11 16.03Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="graph-label">impulses</div>
                        </div>
                    </div>
                </section>

                <div class="secondary-cards-container">
                    <section class="card stage-card">
                        <div class="card-title">Stage</div>
                        <div class="stage-card-content">
                            <div class="stages-list">
                                <!-- Dynamically generated by JS -->
                            </div>
                            <div id="stage-indicator-wrapper" class="stage-indicator">
                                <!-- Dynamically generated by JS -->
                            </div>
                        </div>
                         <div class="stage-footer">this week</div>
                    </section>
                    <section class="card calendar-card">
                        <div id="calendar-grid" class="calendar-grid">
                           <!-- Dynamically generated by JS -->
                        </div>
                        <div class="calendar-labels">
                            <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span>
                        </div>
                    </section>
                </div>
            </div>
        </main>
        
        <footer class="bottom-nav">
            <div class="nav-item">
                <div class="nav-icon">
                     <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 23 23" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.78572 12.8571C8.78572 11.3581 10.0009 10.143 11.5 10.143C12.9991 10.143 14.2143 11.3581 14.2143 12.8571C14.2143 14.3562 12.9991 15.5713 11.5 15.5713C10.7802 15.5713 10.0898 15.2853 9.58073 14.7763C9.07167 14.2673 8.78572 13.5769 8.78572 12.8571Z" stroke="#E0D7D7" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.88664 4.81377L8.59436 2.75104C10.4025 1.74965 12.5989 1.74965 14.407 2.75104L18.1147 4.81377C19.8842 5.78101 20.989 7.63253 21 9.64893V15.3241C20.9524 18.5056 18.335 21.0462 15.1534 20.9994H7.84657C4.66498 21.0462 2.04762 18.5056 2 15.3241V9.64893C2.01125 7.63224 3.11667 5.78065 4.88664 4.81377Z" stroke="#E0D7D7" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item active">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="19" viewBox="0 0 32 19" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 6.78571C0 3.03807 2.98477 0 6.66667 0H25.3333C29.0152 0 32 3.03807 32 6.78571V12.2143C32 15.9619 29.0152 19 25.3333 19H6.66667C2.98477 19 0 15.9619 0 12.2143V6.78571ZM6.66667 2.71429C4.45753 2.71429 2.66667 4.53713 2.66667 6.78571V12.2143C2.66667 14.4629 4.45753 16.2857 6.66667 16.2857H25.3333C27.5425 16.2857 29.3333 14.4629 29.3333 12.2143V6.78571C29.3333 4.53713 27.5425 2.71429 25.3333 2.71429H6.66667ZM13.3333 8.14286C13.3333 6.6438 14.5272 5.42857 16 5.42857C17.4728 5.42857 18.6667 6.6438 18.6667 8.14286V10.8571C18.6667 12.3562 17.4728 13.5714 16 13.5714C14.5272 13.5714 13.3333 12.3562 13.3333 10.8571V8.14286ZM8 5.42857C6.52724 5.42857 5.33333 6.6438 5.33333 8.14286V10.8571C5.33333 12.3562 6.52724 13.5714 8 13.5714C9.47276 13.5714 10.6667 12.3562 10.6667 10.8571V8.14286C10.6667 6.6438 9.47276 5.42857 8 5.42857Z" fill="#F1EBEB"/>
                    </svg>
                </div>
                <div class="nav-label">Progress</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 21 21" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M14.379 6.69999C14.379 4.60429 12.6392 2.89999 10.5 2.89999C8.36075 2.89999 6.62103 4.60429 6.62103 6.69999C6.62103 8.7957 8.36075 10.5 10.5 10.5C12.6392 10.5 14.379 8.7957 14.379 6.69999ZM18.0485 20H16.3185C15.7832 20 15.3487 19.5744 15.3487 19.05C15.3487 18.5256 15.7832 18.1 16.3185 18.1H16.7345C17.4055 18.1 17.9011 17.4378 17.647 16.8289C16.4726 14.0131 13.7147 12.4 10.5 12.4C7.28531 12.4 4.52736 14.0131 3.353 16.8289C3.09893 17.4378 3.59449 18.1 4.26555 18.1H4.68155C5.21684 18.1 5.65129 18.5256 5.65129 19.05C5.65129 19.5744 5.21684 20 4.68155 20H2.95153C1.73935 20 0.785127 18.9141 1.04211 17.7542C1.74808 14.5631 3.95232 12.2081 6.85572 11.1393C5.53105 10.0953 4.68155 8.4955 4.68155 6.69999C4.68155 3.32654 7.67224 0.638028 11.1973 1.03988C13.7515 1.33058 15.8675 3.32459 16.2506 5.81644C16.5803 7.9644 15.6833 9.92617 14.1443 11.1393C17.0477 12.2081 19.2519 14.5631 19.9579 17.7542C20.2149 18.9141 19.2606 20 18.0485 20ZM13.4092 19.05C13.4092 19.5744 12.9748 20 12.4395 20H8.56052C8.02522 20 7.59077 19.5744 7.59077 19.05C7.59077 18.5256 8.02522 18.1 8.56052 18.1H12.4395C12.9748 18.1 13.4092 18.5256 13.4092 19.05Z" fill="#E0D7D7" stroke="#E0D7D7"/>
                    </svg>
                </div>
                <div class="nav-label">Me</div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE & CONFIGURATION ---
            const AppState = {
                dayCount: 0,
                maxProgressDays: 180, // 6 months for progress bar scaling
            };

            const STAGES = [
                { name: "Commitment", threshold: 1 },
                { name: "Temptation", threshold: 7 },
                { name: "Flatline", threshold: 14 },
                { name: "Vitality", threshold: 21 },
                { name: "Conflict", threshold: 28 },
                { name: "Discipline", threshold: 30 },
                { name: "Magnetism", threshold: 90 },
                { name: "Transcendence", threshold: 180 },
            ];

            // --- DOM SELECTORS ---
            const countNumberEl = document.getElementById('count-number');
            const barYouEl = document.getElementById('bar-you');
            const barImpulsesEl = document.getElementById('bar-impulses');
            const stagesListEl = document.querySelector('.stages-list');
            const stageIndicatorWrapperEl = document.getElementById('stage-indicator-wrapper');
            const calendarGridEl = document.getElementById('calendar-grid');
            const resetBtn = document.getElementById('reset-btn');
            
            // --- UI INITIALIZATION & GENERATION ---
            function setupUI() {
                // Populate Stages
                stagesListEl.innerHTML = STAGES.map(stage => `<div class="stage-item">${stage.name}</div>`).join('');
                stageIndicatorWrapperEl.innerHTML = STAGES.map(() => `<div class="indicator-line"></div>`).join('');
                
                // Populate Calendar (e.g., last 25 days for the view)
                calendarGridEl.innerHTML = Array.from({ length: 25 }).map(() => `<div class="calendar-day"></div>`).join('');
            
                // Add click listener to increment days for demo
                barYouEl.parentElement.addEventListener('click', () => {
                    const newCount = Math.min(AppState.dayCount + 1, AppState.maxProgressDays);
                    animateToDay(newCount);
                });

                 // Add click listener to decrement days for demo
                barImpulsesEl.parentElement.addEventListener('click', () => {
                    const newCount = Math.max(AppState.dayCount - 1, 0);
                    animateToDay(newCount);
                });

                resetBtn.addEventListener('click', () => animateToDay(0, true));
            }

            // --- CORE LOGIC & ANIMATION ---
            function updateUI(dayCount, duration = 1.2) {
                const tl = gsap.timeline({ defaults: { duration: duration, ease: 'elastic.out(1, 0.8)' } });

                // 1. Animate Counter
                tl.to(countNumberEl, {
                    innerText: dayCount,
                    snap: { innerText: 1 },
                    onUpdate: () => countNumberEl.innerText = Math.round(countNumberEl.innerText)
                }, 0);

                // 2. Animate Progress Bars
                const youProgress = (dayCount / AppState.maxProgressDays) * 100;
                const impulseProgress = Math.max(5, 100 - (dayCount / (AppState.maxProgressDays/2)) * 100);
                
                tl.to(barYouEl, { height: `${Math.max(5, youProgress)}%` }, 0);
                tl.to(barImpulsesEl, { height: `${impulseProgress}%` }, 0);

                // Animate icons visibility
                tl.to(barYouEl.querySelector('.bar-icon'), { opacity: youProgress > 10 ? 1 : 0, duration: 0.5 }, 0.2);
                tl.to(barImpulsesEl.querySelector('.bar-icon'), { opacity: impulseProgress > 10 ? 1 : 0, duration: 0.5 }, 0.2);

                // 3. Update Stage
                let currentStageIndex = STAGES.length - 1;
                for (let i = 0; i < STAGES.length; i++) {
                    if (dayCount < STAGES[i].threshold) {
                        currentStageIndex = Math.max(0, i - 1);
                        break;
                    }
                }
                
                document.querySelectorAll('.stage-item').forEach((item, index) => {
                    item.classList.toggle('active', index === currentStageIndex);
                    item.classList.toggle('inactive', index !== currentStageIndex);
                });
                
                document.querySelectorAll('.indicator-line').forEach((line, index) => {
                    line.classList.toggle('active', index === currentStageIndex);
                });


                // 4. Update Calendar
                const calendarDays = document.querySelectorAll('.calendar-day');
                calendarDays.forEach((day, index) => {
                    const dayNumber = dayCount - (calendarDays.length - 1 - index);
                    day.className = 'calendar-day'; // reset
                    if (dayNumber > 0 && dayNumber < dayCount) {
                        day.classList.add('complete');
                    } else if (dayNumber === dayCount && dayCount > 0) {
                        day.classList.add('current');
                    }
                });

                return tl;
            }
            
            function animateToDay(targetDay, isReset = false) {
                const duration = isReset ? 2.5 : 1.2;
                AppState.dayCount = targetDay;
                updateUI(targetDay, duration);
            }

            // --- INITIAL LOAD ANIMATION ---
            function initialLoad() {
                const tl = gsap.timeline();
                tl.from('.card, .morsi-logo, .nav-item', {
                    opacity: 0,
                    y: 50,
                    stagger: 0.1,
                    duration: 1,
                    ease: 'power3.out'
                })
                .add(() => animateToDay(13), '-=0.5'); // Start the main animation after entry
            }

            // --- RUN ---
            setupUI();
            initialLoad();
        });

        // Basic PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>

</body>
</html>
