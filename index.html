<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Full-Screen Immersion Directives -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000"> <!-- MODIFICADO: Theme color para o novo fundo -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <title>MORSI</title>

    <!-- Font Architecture -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    
    <!-- The Engine of Motion - GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/TextPlugin.min.js"></script> <!-- MODIFICADO: Adicionado TextPlugin para animação do número -->

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* style.css (Purified, Corrected & Embedded) */

        /*------------------------------------*\
          #ROOT & GLOBAL ARCHITECTURE
        \*------------------------------------*/
        :root {
            /* MODIFICADO: Paleta de cores atualizada */
            --bg-main: #050505;
            --bg-card: #000000;
            --text-primary: #F1EBEB;
            --text-secondary: rgba(241, 235, 235, 0.7);
            --text-tertiary: rgba(241, 235, 235, 0.5);
            --accent-red: #880C0E; /* Cor Massala */
            --accent-red-past: #A31F22; /* Um pouco mais claro para o calendário */
            --accent-green: #39CC59; /* Mantido para referência, mas não usado ativamente */
            --calendar-future: #2C2C2C;
            --font-main: 'Instrument Sans', sans-serif;
            --card-radius: 24px;
            --h-safe-area: env(safe-area-inset-left);
            --v-safe-area-top: env(safe-area-inset-top);
            --v-safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }

        html { height: 100%; overflow: hidden; }

        body {
            width: 100%; min-height: 100dvh; margin: 0 auto;
            background-color: var(--bg-main); /* MODIFICADO */
            color: var(--text-primary);
            font-family: var(--font-main);
            display: flex; flex-direction: column; position: relative;
            overflow: hidden; opacity: 0; transition: opacity 0.5s ease;
        }

        /*------------------------------------*\
          #APP LAYOUT FLOW
        \*------------------------------------*/
        .app-header {
            flex-shrink: 0;
            padding-top: calc(2rem + var(--v-safe-area-top)); /* Ajustado padding */
            padding-bottom: 1.5rem; /* Ajustado padding */
            display: flex; justify-content: center; align-items: center;
        }

        .logo svg { width: auto; height: 1.6rem; }

        .app-main {
            flex-grow: 1; padding: 0 5.2%; overflow-y: auto;
            -ms-overflow-style: none; scrollbar-width: none;
            padding-bottom: 2rem;
        }
        .app-main::-webkit-scrollbar { display: none; }

        .bottom-nav {
            flex-shrink: 0; display: flex; justify-content: space-around; align-items: center;
            padding: 1rem var(--h-safe-area) calc(0.75rem + var(--v-safe-area-bottom)) var(--h-safe-area);
            background: var(--bg-main); /* MODIFICADO para consistência */
        }

        /*------------------------------------*\
          #CARDS & COMPONENTS (MODIFICADO)
        \*------------------------------------*/
        .card {
            background-color: var(--bg-card); /* MODIFICADO */
            border-radius: var(--card-radius);
            padding: 1.5rem;
            margin-bottom: 1rem; /* Adicionado espaçamento padrão */
            opacity: 0;
            transform: translateY(30px);
        }

        /* NOVO: Estilos para o card de métricas (topo) */
        .metrics-card {
            display: flex;
            align-items: stretch;
            gap: 1.5rem;
        }
        .day-count-box {
            background-color: #171717;
            border-radius: 18px;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        #day-count {
            font-size: 3rem;
            font-weight: 600;
            line-height: 1;
        }
        .day-count-box span:last-child {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        .progress-details {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-grow: 1;
            padding: 0.25rem 0;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .progress-header h2 {
            font-size: 1.15rem;
            font-weight: 500;
            line-height: 1.3;
        }
        .reset-button {
            background: none; border: none; color: var(--text-tertiary);
            font-family: var(--font-main); font-size: 1rem; cursor: pointer;
            padding: 0; transition: color 0.3s ease;
        }
        .reset-button:hover { color: var(--text-primary); }
        .week-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #171717;
            padding: 0.5rem 1rem;
            border-radius: 99px;
        }
        .week-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
        }
        .week-day .dot {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: #333;
            transition: background-color 0.5s ease;
        }
        .week-day .dot.past { background-color: #505050; }
        .week-day .dot.current { background-color: var(--text-primary); }
        .week-day span { font-size: 0.75rem; color: var(--text-tertiary); }

        /* NOVO: Estilos para o card visual (meio) */
        .visual-card {
            height: 30vh;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 1rem;
        }
        .you-impulse-visual {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
            background: linear-gradient(to right, var(--text-primary) 50%, #150203 50%);
            overflow: hidden;
        }
        /* Efeito granulado para a parte vermelha */
        .you-impulse-visual::after {
            content: '';
            position: absolute;
            top: -50%; right: -50%; bottom: -50%; left: 50%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNzUiIG51bU9jdGF2ZXM9IjEwIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iMCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNub2lzZSkiLz48L3N2Zz4=');
            background-color: var(--accent-red);
            opacity: 0.4;
            mix-blend-mode: screen;
        }
        .visual-labels {
            display: flex;
            justify-content: space-between;
            width: 220px;
            margin-top: 1.25rem;
            color: var(--text-secondary);
        }

        .lower-grid {
            display: grid;
            grid-template-columns: 197fr 150fr;
            gap: 13px;
            align-items: start;
        }
        .stage-card, .calendar-card { height: 141px; margin-bottom: 0; } /* Remove margin bottom for grid items */
        .stage-card {
            padding: 1rem 0 1rem 1rem;
            display: flex; flex-direction: column; position: relative;
        }
        .stage-card h2 { font-size: 1.1rem; font-weight: 500; padding-left: 0.5rem; }
        .stage-list-container {
            flex-grow: 1; position: relative; overflow: hidden; margin: 0.5rem 0;
        }
        .stage-list-gradient {
            position: absolute; inset: -1px; z-index: 2;
            background: linear-gradient(to bottom, var(--bg-card) 5%, transparent 40%, transparent 60%, var(--bg-card) 95%);
            pointer-events: none;
        }
        .stage-item {
            padding: 0.1rem 0.5rem;
            transition: color 0.8s ease, font-weight 0.8s ease, opacity 0.8s ease;
        }
        .stage-item span { font-size: 1rem; }
        .stage-item.active { color: var(--text-primary); font-weight: 600; opacity: 1; }
        .stage-item:not(.active) { color: var(--text-secondary); font-weight: 400; opacity: 0.6; }
        
        /* MODIFICADO: Estilos do indicador de estágio */
        .stage-indicator {
            display: flex; flex-direction: column; gap: 4px;
            position: absolute; right: 1.5rem; top: 50%;
            transform: translateY(-50%);
            align-items: center; /* Para centralizar a linha pontilhada */
        }
        /* NOVO: Linha pontilhada vermelha */
        .stage-indicator::before {
            content: '';
            position: absolute;
            width: 1px;
            height: calc(100% + 8px); /* Um pouco maior que as bolinhas */
            background-image: linear-gradient(var(--accent-red) 40%, transparent 40%);
            background-size: 1px 6px;
            background-repeat: repeat-y;
            opacity: 0.5;
        }
        .indicator-line {
            height: 2px; background-color: var(--text-tertiary); border-radius: 1px;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative; /* Para ficar sobre a linha pontilhada */
        }
        .indicator-line.active { width: 15px; background-color: var(--text-primary); }
        .indicator-line:not(.active) { width: 6px; }

        .stage-period {
            font-size: 0.8rem; color: var(--text-tertiary);
            padding-left: 0.5rem; margin-top: auto;
        }
        .calendar-card { display: flex; gap: 0.5rem; padding: 1rem; }
        .calendar-weekdays {
            display: flex; flex-direction: column; justify-content: space-around;
            font-size: 0.8rem; color: var(--text-tertiary); padding: 0.1rem 0;
        }
        .calendar-grid {
            flex-grow: 1; display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 0.4rem; align-content: space-around;
        }
        .day-circle {
            width: 10px; height: 10px; border-radius: 50%;
            transition: all 0.5s ease; transform: scale(0); justify-self: center;
        }
        /* MODIFICADO: Cores do calendário */
        .day-circle.past { background-color: var(--accent-red-past); }
        .day-circle.current { background-color: var(--text-primary); }
        .day-circle.future { background-color: var(--calendar-future); }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            gap: 0.25rem; text-decoration: none; color: var(--text-primary);
            opacity: 0.5; transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .nav-item.active { opacity: 1; }
        .nav-item:not(.active):hover { opacity: 0.8; }
        .nav-item span { font-size: 0.75rem; }
        .nav-icon-wrapper { height: 24px; display: flex; align-items: center; justify-content: center; }
        .nav-icon-wrapper svg { max-height: 100%; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo">
            <!-- SVG Logo (inalterado) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="93" height="26" viewBox="0 0 93 26" fill="none"><path d="M26.806 21V5.88H29.452L34.912 20.454H34.114L39.532 5.88H42.22V21H40.519V6.783H40.75L35.479 21H33.421L28.15 6.909H28.381V21H26.806ZM52.2843 21.21C51.2343 21.21 50.2683 21.021 49.3863 20.643C48.5183 20.251 47.7623 19.705 47.1182 19.005C46.4743 18.291 45.9703 17.458 45.6063 16.506C45.2563 15.554 45.0813 14.511 45.0813 13.377C45.0813 11.879 45.3893 10.549 46.0053 9.387C46.6213 8.225 47.4683 7.315 48.5463 6.657C49.6383 5.999 50.8773 5.67 52.2633 5.67C53.6773 5.67 54.9233 5.999 56.0013 6.657C57.0933 7.315 57.9473 8.225 58.5633 9.387C59.1793 10.549 59.4873 11.886 59.4873 13.398C59.4873 14.532 59.3053 15.575 58.9413 16.527C58.5913 17.479 58.0943 18.305 57.4503 19.005C56.8063 19.705 56.0433 20.251 55.1613 20.643C54.2793 21.021 53.3203 21.21 52.2843 21.21ZM52.2633 19.656C53.3413 19.656 54.2863 19.39 55.0983 18.858C55.9243 18.312 56.5683 17.563 57.0303 16.611C57.4923 15.659 57.7233 14.574 57.7233 13.356C57.7233 12.152 57.4923 11.088 57.0303 10.164C56.5823 9.24 55.9453 8.519 55.1192 8.001C54.3073 7.483 53.3553 7.224 52.2633 7.224C51.1713 7.224 50.2193 7.483 49.4073 8.001C48.5953 8.519 47.9653 9.24 47.5173 10.164C47.0693 11.074 46.8453 12.138 46.8453 13.356C46.8453 14.588 47.0693 15.68 47.5173 16.632C47.9793 17.57 48.6163 18.312 49.4282 18.858C50.2403 19.39 51.1853 19.656 52.2633 19.656ZM62.346 21V5.88H67.932C69.01 5.88 69.927 6.055 70.683 6.405C71.439 6.755 72.013 7.245 72.405 7.875C72.811 8.491 73.014 9.226 73.014 10.08C73.014 10.934 72.811 11.683 72.405 12.327C72.013 12.957 71.439 13.454 70.683 13.818C69.927 14.168 69.01 14.343 67.932 14.343H63.606V12.831H67.869C68.989 12.831 69.836 12.586 70.41 12.096C70.998 11.606 71.292 10.934 71.292 10.08C71.292 9.24 71.005 8.582 70.431 8.106C69.857 7.63 69.003 7.392 67.869 7.392H64.068V21H62.346ZM71.208 21L63.165 13.503H65.517L73.812 21H71.208ZM81.0257 21.189C79.2617 21.189 77.8547 20.755 76.8047 19.887C75.7687 19.019 75.1597 17.78 74.9777 16.17H76.6577C76.8117 17.332 77.2527 18.207 77.9807 18.795C78.7087 19.383 79.7167 19.677 81.0047 19.677C82.0967 19.677 82.9157 19.474 83.4617 19.068C84.0217 18.648 84.3017 18.039 84.3017 17.241C84.3017 16.555 84.1127 16.009 83.7347 15.603C83.3567 15.197 82.7687 14.861 81.9707 14.595L79.4297 13.713C78.1417 13.265 77.1897 12.726 76.5737 12.096C75.9577 11.452 75.6497 10.64 75.6497 9.66C75.6497 8.848 75.8527 8.148 76.2587 7.56C76.6647 6.958 77.2387 6.489 77.9807 6.153C78.7227 5.817 79.5837 5.649 80.5637 5.649C82.0757 5.649 83.2867 6.048 84.1967 6.846C85.1067 7.63 85.6317 8.75 85.7717 10.206H84.0917C83.9097 9.156 83.5317 8.386 82.9577 7.896C82.3977 7.406 81.5857 7.161 80.5217 7.161C79.5137 7.161 78.7297 7.364 78.1697 7.77C77.6097 8.176 77.3297 8.75 77.3297 9.492C77.3297 10.122 77.5257 10.626 77.9177 11.004C78.3097 11.382 78.9187 11.711 79.7447 11.991L82.4537 12.936C83.6297 13.342 84.5117 13.895 85.0997 14.595C85.6877 15.281 85.9817 16.156 85.9817 17.22C85.9817 18.48 85.5477 19.46 84.6797 20.16C83.8257 20.846 82.6077 21.189 81.0257 21.189ZM88.6781 21V5.88H90.4001V21H88.6781Z" fill="#E0D7D7"></path><path d="M6.38891 18.381C6.38892 20.8707 8.51542 23 8.51542 23C8.51542 23 10.4262 21.1328 10.6419 18.7741C10.8775 16.1985 10.6419 14.9414 12.1829 12.3534C13.3617 10.3736 16.2201 8.16034 16.2201 8.16034V4.03276C16.2201 4.03276 11.4311 6.78911 9.43998 9.66724C7.41627 12.5925 6.38891 14.75 6.38891 18.381Z" fill="#E0D7D7"></path><path d="M5.49515 19.9534C5.70512 20.7346 6.35808 21.8207 6.35808 21.8207C6.35808 21.8207 2.79178 20.1172 1.1805 17.1034C-0.693476 13.5983 0.225117 8.97931 0.225117 8.97931C0.225117 8.97931 2.93719 10.9776 3.98502 13.4017C5.0197 15.7954 5.0637 18.3483 5.49515 19.9534Z" fill="#E0D7D7"></path><path d="M11.5048 19.9534C11.2949 20.7346 10.6419 21.8207 10.6419 21.8207C10.6419 21.8207 14.2082 20.1172 15.8195 17.1034C17.6935 13.5983 16.7749 8.97931 16.7749 8.97931C16.7749 8.97931 14.0628 10.9776 13.015 13.4017C11.9803 15.7954 11.9363 18.3483 11.5048 19.9534Z" fill="#E0D7D7"></path><path d="M3.4303 10.4534C4.68053 11.8638 5.92663 14.6466 5.92663 14.6466C5.92663 14.6466 6.36205 13.2352 6.75874 12.3862C7.16736 11.5117 7.9915 10.2569 7.9915 10.2569C7.9915 10.2569 6.16528 7.91231 4.75551 6.68621C3.33168 5.44788 0.77987 4 0.77987 4V8.1931C0.77987 8.1931 2.52026 9.42684 3.4303 10.4534Z" fill="#E0D7D7"></path></svg>
        </div>
    </header>

    <main class="app-main">

        <!-- MODIFICADO: Estrutura de cards superior totalmente refeita -->
        <section class="card metrics-card">
            <div class="day-count-box">
                <span id="day-count">13</span>
                <span>days</span>
            </div>
            <div class="progress-details">
                <div class="progress-header">
                    <h2 id="week-context-title">Going into the Second Week</h2>
                    <button id="reset-button" class="reset-button">reset</button>
                </div>
                <div id="week-progress" class="week-progress">
                    <!-- Gerado por JS -->
                </div>
            </div>
        </section>

        <section class="card visual-card">
            <div class="you-impulse-visual">
                <!-- Este elemento é puramente estilizado com CSS para replicar o novo visual -->
            </div>
            <div class="visual-labels">
                <span>you</span>
                <span>impulses</span>
            </div>
        </section>
        
        <div class="lower-grid">
            <section class="card stage-card">
                <h2>Stage</h2>
                <div class="stage-list-container">
                    <div class="stage-list-gradient"></div>
                    <div id="stage-list" class="stage-list"></div>
                </div>
                <div class="stage-indicator"></div>
                <span class="stage-period"></span>
            </section>
            <section class="card calendar-card">
                <div class="calendar-weekdays">
                    <span>S</span> <span>M</span> <span>T</span> <span>W</span> <span>T</span>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </section>
        </div>
    </main>

    <nav class="bottom-nav">
        <!-- Ícone "Progress" MODIFICADO para a nova versão -->
        <a href="index.html" id="nav-home" class="nav-item">
            <div class="nav-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 23 23" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.78572 12.8571C8.78572 11.3581 10.0009 10.143 11.5 10.143C12.9991 10.143 14.2143 11.3581 14.2143 12.8571C14.2143 14.3562 12.9991 15.5713 11.5 15.5713C10.7802 15.5713 10.0898 15.2853 9.58073 14.7763C9.07167 14.2673 8.78572 13.5769 8.78572 12.8571Z" stroke="#F1EBEB" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M4.88664 4.81377L8.59436 2.75104C10.4025 1.74965 12.5989 1.74965 14.407 2.75104L18.1147 4.81377C19.8842 5.78101 20.989 7.63253 21 9.64893V15.3241C20.9524 18.5056 18.335 21.0462 15.1534 20.9994H7.84657C4.66498 21.0462 2.04762 18.5056 2 15.3241V9.64893C2.01125 7.63224 3.11667 5.78065 4.88664 4.81377Z" stroke="#F1EBEB" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"></path></svg></div><span>Home</span>
        </a>
        <a href="#" id="nav-progress" class="nav-item active"> <!-- Adicionada classe active para corresponder à imagem -->
            <div class="nav-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><rect x="2.5" y="6.5" width="19" height="11" rx="5.5" stroke="#F1EBEB" stroke-width="2.2"></rect><circle cx="8" cy="12" r="1.5" fill="#F1EBEB"></circle><circle cx="12" cy="12" r="1.5" fill="#F1EBEB"></circle><circle cx="16" cy="12" r="1.5" fill="#F1EBEB"></circle></svg></div><span>Progress</span>
        </a>
        <a href="#" id="nav-me" class="nav-item">
            <div class="nav-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 21 21" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.379 6.69999C14.379 4.60429 12.6392 2.89999 10.5 2.89999C8.36075 2.89999 6.62103 4.60429 6.62103 6.69999C6.62103 8.7957 8.36075 10.5 10.5 10.5C12.6392 10.5 14.379 8.7957 14.379 6.69999ZM18.0485 20H16.3185C15.7832 20 15.3487 19.5744 15.3487 19.05C15.3487 18.5256 15.7832 18.1 16.3185 18.1H16.7345C17.4055 18.1 17.9011 17.4378 17.647 16.8289C16.4726 14.0131 13.7147 12.4 10.5 12.4C7.28531 12.4 4.52736 14.0131 3.353 16.8289C3.09893 17.4378 3.59449 18.1 4.26555 18.1H4.68155C5.21684 18.1 5.65129 18.5256 5.65129 19.05C5.65129 19.5744 5.21684 20 4.68155 20H2.95153C1.73935 20 0.785127 18.9141 1.04211 17.7542C1.74808 14.5631 3.95232 12.2081 6.85572 11.1393C5.53105 10.0953 4.68155 8.4955 4.68155 6.69999C4.68155 3.32654 7.67224 0.638028 11.1973 1.03988C13.7515 1.33058 15.8675 3.32459 16.2506 5.81644C16.5803 7.9644 15.6833 9.92617 14.1443 11.1393C17.0477 12.2081 19.2519 14.5631 19.9579 17.7542C20.2149 18.9141 19.2606 20 18.0485 20ZM13.4092 19.05C13.4092 19.5744 12.9748 20 12.4395 20H8.56052C8.02522 20 7.59077 19.5744 7.59077 19.05C7.59077 18.5256 8.02522 18.1 8.56052 18.1H12.4395C12.9748 18.1 13.4092 18.5256 13.4092 19.05Z" fill="#F1EBEB"></path></svg></div><span>Me</span>
        </a>
    </nav>

    <script>
        // MODIFICADO: O script não é mais um `type="module"`, pois a lógica 3D foi removida
        document.addEventListener('DOMContentLoaded', async () => {
            gsap.registerPlugin(TextPlugin); // Registrar o plugin do GSAP

            // --- 1. SUPABASE INITIALIZATION ---
            const SUPABASE_URL = 'https://moxwfwcfjkzhhjhrjivi.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1veHdmd2Nmamt6aGhqaHJqaXZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0OTc3NjksImV4cCI6MjA3NjA3Mzc2OX0.97l0wv7ie1BKOU9ad8rIbFoxMsZpp2Sad2kTHbrEzSI';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- 2. GLOBAL STATE ---
            const STATE = {
                user: null, profile: null, dayCount: 0, resetTimestamp: null,
            };
            
            // MODIFICADO: Estágios em lowercase para corresponder ao design
            const ALL_STAGES = [
                { name: "commitment",  range: [0, 1],   period: "first day" }, 
                { name: "temptation",  range: [2, 7],   period: "first week" }, 
                { name: "flatline",    range: [8, 14],  period: "second week" }, 
                { name: "vitality",    range: [15, 21], period: "third week" }, 
                { name: "conflict",    range: [22, 30], period: "fourth week" }, 
                { name: "discipline",  range: [31, 90], period: "one month" }, 
                { name: "magnetism",   range: [91, 180],period: "3 months" }, 
                { name: "transcendence", range: [181, Infinity], period: "6 months" }
            ];

            // MODIFICADO: Seletores de elementos atualizados para a nova estrutura
            const elements = {
                body: document.body,
                dayCount: document.getElementById('day-count'),
                weekContextTitle: document.getElementById('week-context-title'),
                weekProgress: document.getElementById('week-progress'),
                resetButton: document.getElementById('reset-button'),
                stageList: document.getElementById('stage-list'),
                stageIndicator: document.querySelector('.stage-indicator'),
                stagePeriod: document.querySelector('.stage-period'),
                calendarGrid: document.getElementById('calendar-grid'),
                cards: document.querySelectorAll('.card')
            };
            
            // --- 3. DATA & STATE MANAGEMENT (Lógica do Supabase inalterada) ---
            const loadStateFromSupabase = async (userId) => {
                const { data, error } = await _supabase.from('profiles').select('name, reset_timestamp').eq('id', userId).single();
                if (error && error.code !== 'PGRST116') { console.error('Error fetching profile:', error); return false; }
                if (!data) { window.location.replace('onboarding.html'); return false; }
                STATE.profile = data;
                STATE.resetTimestamp = data.reset_timestamp ? new Date(data.reset_timestamp).getTime() : null;
                return true;
            };
            const saveStateToSupabase = async () => {
                if (!STATE.user) return;
                const { error } = await _supabase.from('profiles').update({ reset_timestamp: STATE.resetTimestamp ? new Date(STATE.resetTimestamp).toISOString() : null }).eq('id', STATE.user.id);
                if (error) { console.error('Error saving progress:', error); }
            };
            const calculateAndUpdateDays = () => {
                if (!STATE.resetTimestamp) { STATE.dayCount = 0; return; }
                const elapsedMilliseconds = Date.now() - STATE.resetTimestamp;
                STATE.dayCount = Math.floor(elapsedMilliseconds / (1000 * 60 * 60 * 24));
            };
            
            // --- 4. UI LOGIC ---
            const populateStaticContent = () => {
                // Indicador de estágio
                for(let i = 0; i < 7; i++) {
                    elements.stageIndicator.appendChild(document.createElement('div')).className = 'indicator-line';
                }
                // Progresso da semana
                const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri']; // Removido Sábado
                const fragment = document.createDocumentFragment();
                weekDays.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'week-day';
                    dayEl.innerHTML = `<div class="dot"></div><span>${day}</span>`;
                    fragment.appendChild(dayEl);
                });
                elements.weekProgress.appendChild(fragment);
            };
            
            // --- REMOVIDO: Toda a lógica do Three.js (initSunAnimation, updateSunAnimation, etc.) foi removida daqui. ---

            // --- 5. CORE APP LOGIC ---
            const updateAll = (animate = true) => {
                const day = STATE.dayCount;
                
                let activeStageIndex = ALL_STAGES.findIndex(s => day >= s.range[0] && day <= s.range[1]);
                if (activeStageIndex === -1) activeStageIndex = day > 0 ? ALL_STAGES.length - 1 : 0;
                const activeStage = ALL_STAGES[activeStageIndex];
                
                // Animação do contador de dias
                gsap.to(elements.dayCount, { 
                    innerText: day, 
                    duration: animate ? 1.2 : 0, 
                    snap: { innerText: 1 }, 
                    ease: "power2.inOut" 
                });

                // Atualizar título e progresso da semana
                elements.weekContextTitle.textContent = `Going into the ${activeStage.period}`; // Título dinâmico
                
                const currentDayOfWeek = new Date().getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                elements.weekProgress.querySelectorAll('.week-day').forEach((dayEl, index) => {
                    const dot = dayEl.querySelector('.dot');
                    dot.classList.remove('past', 'current');
                    if(index < currentDayOfWeek) {
                        dot.classList.add('past');
                    } else if (index === currentDayOfWeek) {
                        dot.classList.add('current');
                    }
                });

                // Atualizar Stage
                elements.stagePeriod.textContent = `this week`; // Ou pode ser dinâmico como "activeStage.period"
                elements.stageList.innerHTML = '';
                const stageWindow = 5;
                const start = Math.max(0, activeStageIndex - 2);
                const end = Math.min(ALL_STAGES.length, start + stageWindow);
                const activeStageName = activeStage.name;
                
                for (let i = start; i < end; i++) {
                    const stage = ALL_STAGES[i];
                    const item = document.createElement('div');
                    item.className = `stage-item`;
                    
                    if (stage.name === activeStageName) {
                        item.classList.add('active');
                        item.innerHTML = `<span>${stage.name}</span>`;
                    } else if (i < activeStageIndex) {
                        item.innerHTML = `<span style="text-decoration: line-through; opacity: 0.7;">${stage.name}</span>`;
                    } else {
                        item.innerHTML = `<span>${stage.name}</span>`;
                    }
                    elements.stageList.appendChild(item);
                }

                if (elements.stageList.firstElementChild) {
                    const itemHeight = elements.stageList.firstElementChild.offsetHeight;
                    const containerHeight = elements.stageList.parentElement.offsetHeight;
                    const visualIndex = Math.min(2, activeStageIndex);
                    const offset = (containerHeight / 2) - (itemHeight / 2);
                    const targetY = -(visualIndex * itemHeight) + offset;
                    gsap.to(elements.stageList, { y: targetY, duration: animate ? 1.2 : 0, ease: "power3.inOut" });
                }
                
                elements.stageIndicator.querySelectorAll('.indicator-line').forEach((line, index) => line.classList.toggle('active', index === 2)); // Ajustado para o item do meio

                // Atualizar Calendário
                elements.calendarGrid.innerHTML = '';
                const totalCircles = 28; // Grid maior
                const fragment = document.createDocumentFragment();
                for (let i = 1; i <= totalCircles; i++) {
                    const circle = document.createElement('div');
                    circle.className = 'day-circle';
                    if (i <= day) circle.classList.add('past');
                    if (i === day + 1) circle.classList.add('current');
                    if (i > day + 1) circle.classList.add('future');
                    fragment.appendChild(circle);
                }
                elements.calendarGrid.appendChild(fragment);

                if (animate) {
                    gsap.fromTo('.day-circle', { scale: 0 }, { scale: 1, duration: 0.5, stagger: 0.03, ease: "back.out(2)", delay: 0.5 });
                } else {
                     gsap.set('.day-circle', { scale: 1 });
                }
            };
            
            const handleReset = async () => {
                const confirmed = confirm("Are you sure you want to reset your progress? This action cannot be undone.");
                if (confirmed) {
                    STATE.resetTimestamp = Date.now();
                    await saveStateToSupabase();
                    calculateAndUpdateDays();
                    updateAll(true);
                }
            };

            // --- 6. APP INITIALIZATION & AUTHENTICATION ---
            const initApp = async () => {
                const loaded = await loadStateFromSupabase(STATE.user.id);
                if (!loaded) return; 

                populateStaticContent();
                calculateAndUpdateDays();
                updateAll(false); 
                
                elements.body.style.opacity = '1';
                gsap.to(elements.cards, { opacity: 1, y: 0, duration: 1, stagger: 0.15, ease: "power3.out", delay: 0.3 });
                
                elements.resetButton.addEventListener('click', handleReset);
            };
            
            const checkAuthAndLoad = async () => {
                const { data: { session } } = await _supabase.auth.getSession();
                if (!session) { window.location.replace('login.html'); return; }
                STATE.user = session.user;
                const onboardingComplete = localStorage.getItem('morsiOnboardingComplete');
                if (onboardingComplete !== 'true') { window.location.replace('onboarding.html'); return; }
                await initApp();
            };

            checkAuthAndLoad();
        });
    </script>
</body>
</html>
